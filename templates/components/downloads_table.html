<div class="w-full max-w-6xl space-y-3" id="downloads-table">
  {% if not jobs or not jobs|length %}
    <div class="p-6 border rounded-box text-sm opacity-70">No downloads yet.</div>
  {% else %}
    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Message</th>
            <th>Added</th>
            <th>Finished</th>
            <th>Type</th>
            <th>Client</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
            <tr class="hover">
              <td class="max-w-xs">
                <div class="font-semibold truncate" title="{{ job.title }}">{{ job.title }}</div>
                <div class="text-xs opacity-70">mamid {{ job.torrent_id or "-" }}</div>
              </td>
              <td>
                {% set status = job.status|lower %}
                {% set badge = "badge-ghost" %}
                {% if status == "completed" %}{% set badge = "badge-success" %}
                {% elif status == "failed" %}{% set badge = "badge-error" %}
                {% elif status == "processing" %}{% set badge = "badge-warning" %}
                {% elif status in ["downloading","seeding","pending"] %}{% set badge = "badge-info" %}
                {% endif %}
                <div class="flex flex-col gap-1">
                  <span class="badge {{ badge }} gap-2 capitalize">{{ status }}</span>
                  {% if job.client_state %}
                    <span class="badge badge-outline badge-xs">{{ job.client_state }}</span>
                  {% endif %}
                </div>
              </td>
              <td class="max-w-sm">
                <div class="text-sm truncate" title="{{ job.message or '' }}">{{ job.message or "—" }}</div>
                {% if job.destination_path %}
                  <div class="text-xs opacity-70 truncate" title="{{ job.destination_path }}">{{ job.destination_path }}</div>
                {% endif %}
              </td>
              <td class="text-sm opacity-80">
                {% if job.created_at %}{{ job.created_at.strftime("%Y-%m-%d %H:%M") }}{% else %}—{% endif %}
              </td>
              <td class="text-sm opacity-80">
                {% if job.completed_at %}{{ job.completed_at.strftime("%Y-%m-%d %H:%M") }}{% else %}—{% endif %}
              </td>
              <td class="text-sm">
                {% set mt = (job.media_type or 'audiobook')|lower %}
                {% if mt == 'ebook' %}
                  <span class="flex items-center gap-1"><span class="inline-block w-4 h-4">{% include "icons/book.html" %}</span> Ebook</span>
                {% else %}
                  <span class="flex items-center gap-1"><span class="inline-block w-4 h-4">{% include "icons/speaker.html" %}</span> Audio</span>
                {% endif %}
              </td>
              <td class="text-sm">
                {{ job.provider or "qBittorrent" }}
                {% if job.hash %}
                  <div class="text-xs opacity-70 truncate" title="{{ job.hash }}">hash {{ job.hash }}</div>
                {% endif %}
              </td>
              <td class="text-sm">
                {% set st = job.status|lower %}
                {% if st == "failed" or (st == "seeding" and not job.destination_path) %}
                  <div class="flex gap-2">
                    <button class="btn btn-xs btn-primary"
                            hx-post="{{ base_url }}/downloads/{{ job.id }}/reprocess"
                            hx-target="#downloads-table"
                            hx-swap="outerHTML">
                      Retry
                    </button>
                    <button class="btn btn-xs"
                            hx-post="{{ base_url }}/downloads/{{ job.id }}/delete"
                            hx-target="#downloads-table"
                            hx-swap="outerHTML"
                            hx-confirm="Remove this download entry?">
                      Remove
                    </button>
                  </div>
                {% else %}
                  <span class="opacity-50 text-xs">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
