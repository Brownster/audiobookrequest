{% extends "wishlist_page/base_wishlist.html" %}
{% block head %}
  <title>Wishlist</title>
{% endblock head %}
{% block content %}
  <div class="overflow-x-auto h-[75vh] border-b pb-2 border-b-base-200">
    {% block book_wishlist %}
      <table id="book-table-body" class="table table-pin-rows min-w-[60rem]">
        <thead>
          <tr>
            <th></th>
            <th></th>
            <th>Title</th>
            <th>Author</th>
            <th>Narrator</th>
            <th>Release</th>
            <th>Length (hrs)</th>
            <th># Requested</th>
            <th>Status</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        {% if not books %}
          <div role="alert" class="alert my-2">
            <span class="stroke-info h-6 w-6 shrink-0">{% include "icons/info-circle.html" %}</span>
            <span>
              {% if page.__eq__("wishlist") %}
                No books on your wishlist. Add some
                books by heading to the
                <a preload class="link" href="{{ base_url }}/search">search</a> tab {%
                elif page.__eq__("downloaded") %} No books have been downloaded yet. {%
                endif %}
              </span>
            </div>
          {% endif %}
          <tbody>
            {% for book in books %}
              <tr class="text-xs lg:text-sm" id="{{ book.asin }}">
                <th>{{ loop.index }}</th>
                <td>
                  <div class="size-[4rem] lg:size-[6rem]">
                    {% if book.cover_image %}
                      <img class="object-cover w-full h-full"
                           height="64"
                           width="64"
                           src="{{ book.cover_image }}"
                           alt="{{ book.title }}" />
                    {% else %}
                      <div class="flex items-center justify-center w-full h-full bg-neutral opacity-30">
                        {% include "icons/photo-off.html" %}
                      </div>
                    {% endif %}
                  </div>
                </td>
                <td>
                  <div class="flex flex-col">
                    <a preload
                       href="{{ base_url }}/search?q={{ book.title+' ' +(book.authors|join(",") ) }}"
                       class="font-bold text-primary line-clamp-4"
                       title="{{ book.title }}">{{ book.title }}</a>
                    {% if book.subtitle %}
                      <span class="font-semibold line-clamp-4" title="{{ book.subtitle }}">{{ book.subtitle }}</span>
                    {% endif %}
                  </div>
                </td>
                <td>{{ book.authors|join(", ") }}</td>
                <td>{{ book.narrators|join(", ") }}</td>
                <td class="hidden lg:table-cell">{{ book.release_date.strftime("%B %Y") }}</td>
                <td class="lg:hidden">{{ book.release_date.strftime("%Y") }}</td>
                <td>{{ book.runtime_length_hrs }}</td>
                <td title="{{ book.requested_by|join('\n') }}">{{ book.amount_requested }}</td>
                <td>
                  {% set st = (book.pipeline_status or 'pending')|lower %}
                  {# If waiting on MAM, override status display #}
                  {% if book.mam_unavailable %}
                    <div class="flex flex-col gap-1">
                      <span class="badge badge-warning gap-1">MAM Pending</span>
                      <span class="text-[0.65rem] opacity-70">Not available yet</span>
                    </div>
                  {% else %}
                    {% set badge = "badge-ghost" %}
                    {% set display_status = st %}
                    {% if st in ["completed"] %}
                      {% set badge = "badge-success" %}
                    {% elif st == "no_results" %}
                      {% set badge = "badge-error" %}
                      {% set display_status = "Not Found" %}
                    {% elif st == "failed" %}
                      {% set badge = "badge-error" %}
                    {% elif st in ["processing","downloading","seeding","pending"] %}
                      {% set badge = "badge-info" %}
                    {% endif %}
                    <div class="flex flex-col gap-1">
                      <span class="badge {{ badge }} gap-1 capitalize">{{ display_status }}</span>
                      {% if book.pipeline_message %}
                        <span class="text-[0.65rem] opacity-70 line-clamp-2" title="{{ book.pipeline_message }}">{{ book.pipeline_message }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </td>
                <td class="text-xs">
                  {% set mt = (book.media_type or 'audiobook')|lower %}
                  {% if mt == 'ebook' %}
                    <span class="flex items-center gap-1"><span class="inline-block w-4 h-4">{% include "icons/book.html" %}</span> Ebook</span>
                  {% else %}
                    <span class="flex items-center gap-1"><span class="inline-block w-4 h-4">{% include "icons/speaker.html" %}</span> Audio</span>
                  {% endif %}
                </td>
                <td>
                  {% if book.downloaded %}
                    {# Already downloaded - show minimal actions #}
                    <div class="flex gap-1">
                      <button title="Remove from wishlist"
                              class="btn btn-square btn-sm btn-ghost"
                              {% if not user.is_admin() %}disabled{% endif %}
                              hx-delete="{{ base_url }}/search/request/{{ book.asin }}?downloaded=true"
                              hx-swap="outerHTML"
                              hx-target="#book-table-body"
                              hx-disabled-elt="this">
                        {% include "icons/ban.html" %}
                      </button>
                      <span class="badge badge-success badge-sm gap-1">
                        {% include "icons/checkmark.html" %}
                      </span>
                    </div>
                  {% else %}
                    {# Not downloaded yet - show all actions #}
                    <div class="flex gap-1">
                      <button title="Remove from wishlist"
                              class="btn btn-square btn-sm btn-error btn-outline"
                              {% if not user.is_admin() %}disabled{% endif %}
                              hx-delete="{{ base_url }}/search/request/{{ book.asin }}"
                              hx-swap="outerHTML"
                              hx-target="#book-table-body"
                              hx-disabled-elt="this"
                              hx-confirm="Remove {{ book.title }} from wishlist?">
                        {% include "icons/ban.html" %}
                      </button>
                      <a preload
                         title="Manual Search: Open MAM search with this book pre-filled"
                         class="btn btn-square btn-sm btn-primary btn-outline"
                         href="{{ base_url }}/search/mam?{% if book.id %}request_id={{ book.id }}&{% endif %}q={{ book.title | urlencode }}">
                        {% include "icons/search.html" %}
                      </a>
                      <button title="Mark as Downloaded: For when things go wrong"
                              class="btn btn-square btn-sm btn-success btn-outline"
                              {% if not user.is_admin() %}disabled{% endif %}
                              hx-patch="{{ base_url }}/wishlist/downloaded/{{ book.asin }}"
                              hx-swap="outerHTML"
                              hx-target="#book-table-body"
                              hx-disabled-elt="this">
                        {% include "icons/checkmark.html" %}
                      </button>
                      <button title="Auto Download: Automatically search MAM and download best match"
                              class="btn btn-square btn-sm btn-secondary"
                              hx-post="{{ base_url }}/wishlist/mam-auto/{{ book.id }}"
                              hx-swap="outerHTML"
                              hx-target="#book-table-body"
                              hx-disabled-elt="this"
                              {% if not user.can_download() %}disabled{% endif %}>
                        {% include "icons/download.html" %}
                      </button>
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        {% endblock book_wishlist %}
      </table>
    </div>
  {% endblock content %}
