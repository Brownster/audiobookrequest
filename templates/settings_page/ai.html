{% extends "settings_page/base.html" %}
{% block content %}
<div class="card bg-base-200">
  <div class="card-body gap-6">
    <div>
      <h2 class="card-title">AI Recommendations</h2>
      <p class="opacity-70">Use a local Ollama server or the OpenAI API to power AI-based recommendations.</p>
    </div>

    <div class="divider">Configuration</div>
    <form hx-post="{{ base_url }}/settings/ai/config" hx-swap="none" class="flex flex-col gap-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="form-control">
          <label class="label"><span class="label-text">Provider</span></label>
          <select name="provider" class="select select-bordered">
            <option value="ollama" {% if ai_provider == "ollama" %}selected{% endif %}>Ollama</option>
            <option value="openai" {% if ai_provider == "openai" %}selected{% endif %}>OpenAI</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Model</span></label>
          <input name="model" type="text" class="input input-bordered" placeholder="llama3.1 or gpt-4o-mini" value="{{ ai_model }}" />
        </div>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text">Endpoint</span></label>
        <input name="endpoint" type="text" class="input input-bordered" placeholder="http://localhost:11434 or https://api.openai.com" value="{{ ai_endpoint }}" />
        <div class="text-xs opacity-60">
          Ollama: e.g., http://localhost:11434 or http://host.docker.internal:11434 (when ABR is in Docker).<br>
          OpenAI: leave as https://api.openai.com or point to a compatible proxy.
        </div>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text">API Key (OpenAI only)</span></label>
        <input name="api_key" type="password" class="input input-bordered" placeholder="sk-..." value="{{ ai_api_key }}" />
        <div class="text-xs opacity-60">Required for OpenAI; ignored for Ollama.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="form-control">
          <label class="label"><span class="label-text">AI cache TTL (days)</span></label>
          <input name="cache_ttl_days"
                 type="number"
                 min="1"
                 max="7"
                 class="input input-bordered"
                 value="{{ ai_cache_ttl_days or 1 }}" />
          <div class="text-xs opacity-60">How long to cache AI recommendations before re-calling the model (1â€“7 days).</div>
        </div>
      </div>

      <div class="mt-2"><button class="btn btn-primary">Save</button></div>
    </form>

    <div class="divider">Diagnostics</div>
    <div class="flex items-center gap-3">
      <button class="btn" hx-post="{{ base_url }}/settings/ai/test" hx-target="#ai-test-status" hx-swap="innerHTML">Test Connection</button>
      <a href="{{ base_url }}/recommendations/ai?refresh=true" class="btn btn-outline">Generate Now</a>
    </div>
    <div id="ai-test-status" class="mt-2">
      {% if test_result_html %}{{ test_result_html | safe }}{% endif %}
    </div>

    <div class="divider"></div>
    <div class="opacity-70">Once saved, one or more AI Picks sections will appear on the homepage. You can also browse <a class="link link-primary" href="{{ base_url }}/recommendations/ai">AI Recommendations</a>.</div>
  </div>
  </div>
{% endblock content %}
