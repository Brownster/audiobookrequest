{% extends "base.html" %}
{% block head %}
  <title>MAM Search</title>
  <script>
  const onSearch = () => {
    const search_term = document.querySelector('input[name="q"]').value;
    const media = document.querySelector('input[name="media"]:checked')?.value || "audiobook";
    const requestIdEl = document.querySelector('input[name="request_id"]');
    document.getElementById("search").disabled = true;
    document.getElementById("search-text").style.display = "none";
    document.getElementById("search-spinner").style.display = "inline-block";
    let url = `/search/mam?q=${encodeURIComponent(search_term)}&media=${encodeURIComponent(media)}`;
    if (requestIdEl && requestIdEl.value) {
      url += `&request_id=${encodeURIComponent(requestIdEl.value)}`;
    }
    window.location.href = url;
    return false;
  };
  </script>
{% endblock head %}
{% block body %}
  <div class="w-screen flex flex-col items-center justify-center p-6 sm:p-8 overflow-x-hidden gap-4">
    <div class="flex w-full justify-between items-center">
      <h1 class="text-3xl font-bold text-left">MAM Search</h1>
      <a href="{{ base_url }}/search" class="btn btn-ghost">Back to Audible Search</a>
    </div>
    {% if error %}
      <div class="alert alert-error w-full max-w-6xl">
        <span class="stroke-info h-6 w-6 shrink-0">{% include "icons/info-circle.html" %}</span>
        <div>
          <div class="font-semibold">Could not search MAM</div>
          <div class="text-sm">{{ error }}</div>
        </div>
      </div>
    {% endif %}
    {% if not request_id %}
      <div class="alert alert-warning w-full max-w-6xl">
        <span>No request selected. Results can be viewed, but downloads need to be started from a request page so they stay linked.</span>
      </div>
    {% endif %}
    <div class="flex flex-col gap-4 justify-start items-center w-full max-w-6xl">
      <form class="flex flex-col gap-2 w-full" onsubmit="onSearch(); return false;">
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="media" value="audiobook" class="radio radio-primary" {% if media_type != 'ebook' %}checked{% endif %} />
            <span>Audiobooks</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="media" value="ebook" class="radio radio-primary" {% if media_type == 'ebook' %}checked{% endif %} />
            <span>Ebooks</span>
          </label>
        </div>
        <div class="flex items-start w-full join">
          <input name="q"
                 class="input join-item focus:z-10 w-full"
                 placeholder="Search MAM..."
                 value="{{ search_term }}"
                 autofocus />
          <input type="hidden" name="request_id" value="{{ request_id or '' }}">
          <button id="search" class="btn btn-primary join-item" type="submit">
            <span id="search-text">Search</span>
            <span id="search-spinner" class="loading hidden"></span>
          </button>
        </div>
      </form>

      {% if search_results %}
        <div class="w-full">
          <div class="flex justify-between items-center mb-3">
            <div class="text-sm opacity-70">{{ search_results|length }} result{{ 's' if search_results|length != 1 else '' }} found</div>
          </div>
          <div class="flex flex-col gap-3">
            {% for result in search_results %}
              {% set raw = result.source.raw %}
              <div class="card bg-base-200 shadow-md hover:shadow-lg transition-shadow">
                <div class="card-body p-4">
                  <div class="flex gap-4">
                    {# Cover Image #}
                    <div class="flex-shrink-0">
                      <div class="relative w-20 h-20 rounded-md overflow-hidden shadow flex items-center justify-center bg-base-300">
                        {% if result.cover_image %}
                          <img class="object-cover w-full h-full"
                               src="{{ result.cover_image }}"
                               alt="{{ result.title }}" />
                        {% else %}
                          <div class="opacity-30">{% include "icons/photo-off.html" %}</div>
                        {% endif %}
                      </div>
                    </div>

                    {# Main Content #}
                    <div class="flex-grow min-w-0">
                      {# Title and Author #}
                      <h3 class="text-base font-bold text-primary mb-1">{{ result.title }}</h3>
                      <div class="text-sm mb-2">
                        <span class="opacity-70">by</span> <span class="font-semibold">{{ result.authors | join(', ') }}</span>
                      </div>

                      {# Metadata Row #}
                      <div class="flex flex-wrap gap-3 text-xs mb-2">
                        {% if result.narrators %}
                          <div class="flex items-center gap-1">
                            <span class="opacity-70">Narrated by:</span>
                            <span class="font-medium">{{ result.narrators | join(', ') }}</span>
                            <span class="opacity-30">|</span>
                          </div>
                        {% endif %}
                        {% if result.filetype %}
                          <div class="flex items-center gap-1">
                            <span class="opacity-70">Format:</span>
                            <span class="font-medium">{{ result.filetype }}</span>
                            <span class="opacity-30">|</span>
                          </div>
                        {% endif %}
                        {% if result.size %}
                          <div class="flex items-center gap-1">
                            <span class="opacity-70">Size:</span>
                            <span class="font-medium">{{ "%.1f"|format(result.size / (1024**3)) }} GiB</span>
                            <span class="opacity-30">|</span>
                          </div>
                        {% endif %}
                        {% if result.publish_date %}
                          <div class="flex items-center gap-1">
                            <span class="opacity-70">Published:</span>
                            <span class="font-medium">{{ result.publish_date[:10] }}</span>
                          </div>
                        {% endif %}
                      </div>

                      {# Badges and Stats #}
                      <div class="flex flex-wrap gap-2 items-center">
                        <div class="badge badge-success badge-lg gap-1 font-bold">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                          </svg>
                          <span class="text-base">{{ result.seeders }}</span>
                        </div>
                        <div class="badge badge-ghost badge-sm gap-1">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                          </svg>
                          {{ result.leechers or 0 }}
                        </div>
                        {% if 'freeleech' in result.flags %}
                          <div class="badge badge-warning badge-sm gap-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                            </svg>
                            FL
                          </div>
                        {% endif %}
                        {% if 'vip' in result.flags %}
                          <div class="badge badge-secondary badge-outline badge-sm">VIP</div>
                        {% endif %}
                        <span class="badge badge-neutral badge-xs opacity-50">{{ raw.id }}</span>
                      </div>
                    </div>

                    {# Download Button #}
                    <div class="flex-shrink-0">
                      <button class="btn btn-primary btn-sm"
                              hx-post="{{ base_url }}/search/mam/download"
                              hx-vals='{"torrent_id": "{{ result.source.raw.id }}", "title": {{ result.title | tojson }}, "authors": {{ result.authors | tojson }}, "cover_image": {{ result.cover_image | tojson }}, "media_type": "{{ media_type | default("audiobook") }}"{% if request_id %}, "request_id": "{{ request_id }}"{% endif %}}'
                              hx-swap="outerHTML">
                        <span class="w-4 h-4">{% include "icons/download.html" %}</span>
                        Download
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% elif search_term %}
        <div class="text-center p-8">
            <span class="text-xl font-semibold">No results found on MAM</span>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock body %}
